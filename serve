#!/usr/bin/env bash
set -euo pipefail

cd "$(dirname "${BASH_SOURCE[0]}")" || exit 1

DIR="./bin"
LOG_FILE="./logs/runner.txt"

declare -A PIDS

cleanup() {
    echo "Shutting down all processes..."
    for pid in "${PIDS[@]}"; do
        if kill -0 "$pid" 2>/dev/null; then
            kill "$pid"
        fi
    done

    # Wait for all children to exit
    wait
    echo "All processes stopped."
    exit 0
}

trap cleanup SIGINT SIGTERM

mkdir -p "$(dirname "$LOG_FILE")"

for prog in "$DIR"/*; do
    if [[ -x "$prog" && ! -d "$prog" ]]; then
        echo "Starting $prog"
        "$prog" &
        pid=$!
        PIDS["$prog"]=$pid
    fi
done

# Wait for all programs normally
wait
