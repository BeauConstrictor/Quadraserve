#!/bin/env bash

cd "$(dirname "${BASH_SOURCE[0]}")" || exit 1

DIR="./bin/"
LOG_FILE="./logs/runner.txt"

# TODO: remove bashisms
declare -A PIDS

cleanup() {
    echo "Shutting down all processes..."
    for pid in "${PIDS[@]}"; do
        if kill -0 "$pid" 2>/dev/null; then
            kill "$pid"
        fi
    done
    exit 0
}

trap cleanup SIGINT SIGTERM

start_program() {
    local prog="$1"
    while true; do
        "$prog" &
        local pid=$!
        PIDS["$prog"]=$pid

        wait $pid
        # Only log if not terminating
        if [[ $? -ne 0 ]]; then
            echo "$(date '+%Y-%m-%d %H:%M:%S') - $prog exited. Restarting..." >> "$LOG_FILE"
        fi
    done
}

for prog in "$DIR"/*; do
    if [[ -x "$prog" && ! -d "$prog" ]]; then
        start_program "$prog" &
    fi
done

wait
